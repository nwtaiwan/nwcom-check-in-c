<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>外勤人員打卡系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Leaflet Map Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; touch-action: manipulation; }
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #map { height: 300px; } /* Increased map height for better view */
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg overflow-hidden flex flex-col h-screen max-h-[95vh]">
        
        <!-- 登入畫面 -->
        <div id="login-view" class="flex-1 overflow-y-auto">
            <header class="bg-white p-6 text-center border-b">
                <img src="https://static.wixstatic.com/media/6148f9_56377cef73c1498f95a2c3057b89f2ed~mv2.png" alt="西北保全 Logo" class="mx-auto" style="width: 120px; height: 60px;">
                <h1 class="text-xl font-bold text-red-600 mt-4">西北保全人員打卡系統</h1>
            </header>
            <main class="p-6 md:p-8">
                <div class="space-y-4">
                    <div>
                        <div class="flex items-center justify-between">
                            <label for="email" class="block text-sm font-medium text-gray-700">電子郵件</label>
                            <div class="flex items-center text-sm">
                                <input id="remember-me" type="checkbox" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                                <label for="remember-me" class="ml-1.5 text-gray-700">記住我</label>
                            </div>
                        </div>
                        <input type="email" id="email" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="your.email@company.com">
                    </div>
                    <div>
                        <div class="flex items-center justify-between">
                             <label for="login-password" class="block text-sm font-medium text-gray-700">密碼</label>
                             <a href="#" id="forgot-password-link" class="text-sm text-red-600 hover:text-red-500">忘記密碼?</a>
                        </div>
                        <div class="relative mt-1">
                            <input type="password" id="login-password" class="block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500 pr-10" placeholder="••••••••">
                            <button type="button" id="toggle-password-btn" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-700">
                            </button>
                        </div>
                    </div>
                    <button id="login-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>
                        <span>登入</span>
                    </button>
                    <p id="login-message" class="text-red-500 text-sm text-center min-h-[20px]"></p>
                </div>
            </main>
        </div>

        <!-- 主操作畫面 -->
        <div id="main-view" class="hidden flex-1 flex flex-col">
            <header class="bg-red-600 text-white p-6 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <img src="https://static.wixstatic.com/media/6148f9_56377cef73c1498f95a2c3057b89f2ed~mv2.png" alt="西北保全 Logo" style="width: 40px; height: 20px; object-fit: contain;">
                    <div>
                        <h1 class="text-xl font-bold">西北保全打卡系統</h1>
                        <p id="user-email-display" class="text-sm opacity-90"></p>
                    </div>
                </div>
                <button id="logout-btn" class="bg-white hover:bg-gray-100 text-red-600 font-bold py-2 px-4 rounded-lg shadow-sm border border-red-700 transition-colors flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                    <span>登出</span>
                </button>
            </header>

            <!-- 可滾動的內容區域 -->
            <main class="flex-1 overflow-y-auto p-6 md:p-8">
                <div id="message-box" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert">
                    <span class="font-medium" id="message-content"></span>
                </div>

                <!-- 儀表板頁面 -->
                <div id="dashboard-page">
                    <!-- 狀態顯示區 -->
                    <div id="status-card" class="bg-gray-50 rounded-lg p-5 mb-6 text-center border transition-all">
                         <div class="flex justify-between items-center">
                            <div class="text-left">
                                <h2 class="text-lg font-semibold text-gray-700 mb-1">目前狀態</h2>
                                <p id="current-status" class="text-2xl font-bold text-gray-800">尚未打卡</p>
                            </div>
                            <div class="text-right">
                                 <h2 class="text-lg font-semibold text-gray-700 mb-1">今日工時</h2>
                                <p id="work-duration" class="text-2xl font-bold text-gray-800">-- 小時 -- 分</p>
                            </div>
                         </div>
                    </div>
                    <!-- 打卡紀錄 -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-3 border-b pb-2">今日打卡紀錄</h3>
                        <div id="history-log" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                        </div>
                    </div>
                </div>

                <!-- 打卡頁面 -->
                <div id="checkin-page" class="hidden">
                     <!-- Map Display -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3 border-b pb-2 flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                            <span>目前位置</span>
                        </h3>
                        <div id="map" class="w-full rounded-lg bg-gray-200 flex items-center justify-center text-gray-500 overflow-hidden">
                            正在取得 GPS 定位...
                        </div>
                    </div>
                    <!-- 打卡按鈕區 -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <button id="clock-in-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-4 rounded-lg shadow-md transition-all duration-200 flex items-center justify-center space-x-2 disabled:bg-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10.5V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h12.5"/><path d="m16 16-2 2 4 4 4-4-2-2"/><path d="M18 10V2"/></svg>
                            <span>上班打卡</span>
                        </button>
                        <button id="clock-out-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-4 rounded-lg shadow-md transition-all duration-200 flex items-center justify-center space-x-2 disabled:bg-gray-400" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 13.5V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h12.5"/><path d="m16 22 5-5-5-5"/><path d="M18 10V2"/></svg>
                            <span>下班打卡</span>
                        </button>
                    </div>
                </div>
            </main>

            <!-- 底部導覽列 -->
            <nav id="bottom-nav" class="w-full border-t bg-gray-50">
                <div class="flex justify-around">
                    <button id="nav-dashboard-btn" class="flex-1 p-3 text-center text-gray-500 flex flex-col items-center justify-center space-y-1 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
                        <span class="text-xs font-medium">儀表板</span>
                    </button>
                    <button id="nav-checkin-btn" class="flex-1 p-3 text-center text-gray-500 flex flex-col items-center justify-center space-y-1 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                        <span class="text-xs font-medium">打卡</span>
                    </button>
                </div>
            </nav>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyDr9Bk0x0MiauuO_mzPOnLhYdhJ08pdxLo",
      authDomain: "nwcom-check-in.firebaseapp.com",
      projectId: "nwcom-check-in",
      storageBucket: "nwcom-check-in.appspot.com",
      messagingSenderId: "598559960060",
      appId: "1:598559960060:web:197586299700c85a256079",
      measurementId: "G-2WY1HVMD2S"
    };

    // --- DOM 元素 ---
    const loginView = document.getElementById('login-view'), mainView = document.getElementById('main-view');
    const emailInput = document.getElementById('email'), passwordInput = document.getElementById('login-password');
    const togglePasswordBtn = document.getElementById('toggle-password-btn'), rememberMeCheckbox = document.getElementById('remember-me');
    const loginBtn = document.getElementById('login-btn'), loginMessage = document.getElementById('login-message');
    const logoutBtn = document.getElementById('logout-btn'), userEmailDisplay = document.getElementById('user-email-display');
    const forgotPasswordLink = document.getElementById('forgot-password-link');
    const currentStatusEl = document.getElementById('current-status'), workDurationEl = document.getElementById('work-duration');
    const clockInBtn = document.getElementById('clock-in-btn'), clockOutBtn = document.getElementById('clock-out-btn');
    const historyLogEl = document.getElementById('history-log');
    const messageBoxEl = document.getElementById('message-box'), messageContentEl = document.getElementById('message-content');
    const statusCardEl = document.getElementById('status-card');
    const mapContainer = document.getElementById('map');
    
    // --- 頁面與導覽按鈕 ---
    const dashboardPage = document.getElementById('dashboard-page');
    const checkinPage = document.getElementById('checkin-page');
    const navDashboardBtn = document.getElementById('nav-dashboard-btn');
    const navCheckinBtn = document.getElementById('nav-checkin-btn');

    const eyeIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
    const eyeOffIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path><line x1="2" x2="22" y1="2" y2="22"></line></svg>`;
    
    let workDurationInterval = null, unsubscribeFromHistory = null;
    let map = null, marker = null, currentPosition = null, locationWatcherId = null;

    // --- Firebase 設定檢查 ---
    function checkFirebaseConfig() {
        if (firebaseConfig.apiKey.startsWith("AIzaSy") === false) {
            loginMessage.textContent = "錯誤：請在程式碼中貼上您的 Firebase 設定。";
            loginBtn.disabled = true;
            loginBtn.innerHTML = `<span>設定未完成</span>`;
            loginBtn.classList.replace('bg-red-600', 'bg-gray-400');
            return false;
        }
        return true;
    }

    // --- 主程式邏輯 ---
    if (checkFirebaseConfig()) {
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        initializeLoginScreen();
        initializeNavigation(); // 初始化導覽列
        
        onAuthStateChanged(auth, user => {
            if (user) {
                loginView.classList.add('hidden');
                mainView.classList.remove('hidden');
                mainView.classList.add('flex');
                userEmailDisplay.textContent = `歡迎, ${user.email}`;
                listenToTodayRecords(user.uid);
                startLocationWatcher();
                showPage('dashboard'); // 登入後預設顯示儀表板
            } else {
                loginView.classList.remove('hidden');
                loginView.classList.remove('flex-1', 'overflow-y-auto');
                mainView.classList.add('hidden');
                mainView.classList.remove('flex');
                if (unsubscribeFromHistory) unsubscribeFromHistory();
                if (workDurationInterval) clearInterval(workDurationInterval);
                stopLocationWatcher();
                clearMainView();
            }
        });
        
        // --- 頁面切換邏輯 ---
        function initializeNavigation() {
            navDashboardBtn.addEventListener('click', () => showPage('dashboard'));
            navCheckinBtn.addEventListener('click', () => showPage('checkin'));
        }

        function setActiveTab(activeBtn) {
            const baseClasses = 'flex-1 p-3 text-center text-gray-500 flex flex-col items-center justify-center space-y-1 transition-colors duration-200';
            navDashboardBtn.className = baseClasses;
            navCheckinBtn.className = baseClasses;

            activeBtn.classList.remove('text-gray-500');
            activeBtn.classList.add('text-red-600', 'bg-red-50');
        }

        function showPage(pageName) {
            if (pageName === 'dashboard') {
                dashboardPage.classList.remove('hidden');
                checkinPage.classList.add('hidden');
                setActiveTab(navDashboardBtn);
            } else if (pageName === 'checkin') {
                dashboardPage.classList.add('hidden');
                checkinPage.classList.remove('hidden');
                setActiveTab(navCheckinBtn);
                // 當地圖容器從 hidden 變為可見時，需要重新計算地圖尺寸
                if (map) {
                    setTimeout(() => map.invalidateSize(), 10);
                }
            }
        }

        // --- 登入/登出相關 ---
        function initializeLoginScreen() {
            const savedEmail = localStorage.getItem('rememberedEmail');
            if (savedEmail) {
                emailInput.value = savedEmail;
                rememberMeCheckbox.checked = true;
            }
            togglePasswordBtn.innerHTML = eyeIcon;
        }

        loginBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            loginMessage.textContent = '';
            if (rememberMeCheckbox.checked) {
                localStorage.setItem('rememberedEmail', email);
            } else {
                localStorage.removeItem('rememberedEmail');
            }
            toggleButtonLoading(loginBtn, true, '登入中...');
            try {
                if (email === '11' && password === '11') {
                    await signInWithEmailAndPassword(auth, 'test@company.com', 'password123');
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                console.error("Login failed:", error);
                const message = (error.code === 'auth/invalid-credential') 
                    ? '登入失敗，帳號或密碼錯誤。' 
                    : '登入時發生未知錯誤。';
                loginMessage.textContent = message;
            } finally {
                toggleButtonLoading(loginBtn, false, '登入');
            }
        });
        
        logoutBtn.addEventListener('click', () => signOut(auth));

        togglePasswordBtn.addEventListener('click', () => {
            const isPassword = passwordInput.type === 'password';
            passwordInput.type = isPassword ? 'text' : 'password';
            togglePasswordBtn.innerHTML = isPassword ? eyeOffIcon : eyeIcon;
        });

        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            const email = emailInput.value;
            if (!email) {
                loginMessage.textContent = '請先輸入您的電子郵件以重設密碼。';
                return;
            }
            sendPasswordResetEmail(auth, email)
                .then(() => {
                    loginMessage.textContent = `密碼重設信件已寄至 ${email}，請查收。`;
                    loginMessage.className = "text-green-600 text-sm text-center min-h-[20px]";
                })
                .catch((error) => {
                    loginMessage.textContent = '無法傳送密碼重設信件，請確認郵件地址是否正確。';
                     loginMessage.className = "text-red-500 text-sm text-center min-h-[20px]";
                });
        });

        // --- 地圖與定位邏輯 ---
        function startLocationWatcher() {
            if (locationWatcherId) return; // 防止重複啟動
            if (!navigator.geolocation) {
                mapContainer.innerHTML = '您的瀏覽器不支援 GPS 定位。';
                return;
            }
            
            locationWatcherId = navigator.geolocation.watchPosition(
                (pos) => {
                    currentPosition = pos;
                    const { latitude, longitude } = pos.coords;
                    const latLng = L.latLng(latitude, longitude);

                    if (!map) { 
                        initMap(latLng);
                    } else { 
                        map.setView(latLng, 17);
                        marker.setLatLng(latLng);
                    }
                },
                (error) => {
                    console.error("Geolocation error:", error);
                    let message = '無法取得 GPS 位置。';
                    if(error.code === error.PERMISSION_DENIED) {
                        message = '您已拒絕 GPS 定位權限，請至瀏覽器設定中重新開啟。';
                    }
                    mapContainer.innerHTML = `<div class="p-4 text-center">${message}</div>`;
                    currentPosition = null;
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function stopLocationWatcher() {
            if (locationWatcherId) {
                navigator.geolocation.clearWatch(locationWatcherId);
            }
            if (map) {
                map.remove();
                map = null;
            }
            locationWatcherId = null;
            currentPosition = null;
            marker = null;
            mapContainer.innerHTML = '正在取得 GPS 定位...';
        }

        function initMap(latLng) {
            mapContainer.innerHTML = ''; 
            map = L.map('map').setView(latLng, 17);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
            marker = L.marker(latLng).addTo(map);
        }

        // --- 打卡邏輯 ---
        async function handleClockAction(type) {
            const user = auth.currentUser;
            if (!user) {
                showMessage('使用者未登入，無法打卡。', 'error');
                return;
            }
            if (!currentPosition) {
                showMessage('無法取得您的目前位置，請檢查定位權限後再試。', 'error');
                return;
            }

            const buttonToLoad = type === 'in' ? clockInBtn : clockOutBtn;
            const originalText = type === 'in' ? '上班打卡' : '下班打卡';
            toggleButtonLoading(buttonToLoad, true, '傳送中...');
            
            try {
                const { latitude, longitude } = currentPosition.coords;
                const record = {
                    userId: user.uid, userEmail: user.email, type,
                    timestamp: serverTimestamp(),
                    coords: { latitude, longitude },
                    mapLink: `https://www.openstreetmap.org/?mlat=${latitude}&mlon=${longitude}#map=18/${latitude}/${longitude}`,
                };
                await addDoc(collection(db, "clock_records"), record);
                showMessage(`${originalText}成功！`, 'success');
            } catch (error) {
                showMessage('打卡失敗，同步資料時發生錯誤。', 'error');
                console.error("Clock action error:", error);
            } finally {
                toggleButtonLoading(buttonToLoad, false, originalText);
            }
        }
        
        clockInBtn.addEventListener('click', () => handleClockAction('in'));
        clockOutBtn.addEventListener('click', () => handleClockAction('out'));
        
        // --- 資料監聽與畫面渲染 ---
        function listenToTodayRecords(userId) {
            if (unsubscribeFromHistory) unsubscribeFromHistory();
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const q = query(
                collection(db, "clock_records"),
                where("userId", "==", userId),
                where("timestamp", ">=", today),
                orderBy("timestamp", "desc")
            );
            unsubscribeFromHistory = onSnapshot(q, (snapshot) => {
                const history = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return { ...data, id: doc.id, timestamp: data.timestamp?.toDate() };
                }).filter(item => item.timestamp);
                
                renderHistory(history);
                updateUI(history);
            }, (error) => {
                console.error("讀取紀錄失敗: ", error);
                renderError(error);
            });
        }
        
        function updateUI(history) {
            const lastAction = history[0];
            const isClockedIn = lastAction && lastAction.type === 'in';
            
            if (isClockedIn) {
                currentStatusEl.textContent = '工作中';
                statusCardEl.className = 'bg-green-50 rounded-lg p-5 mb-6 text-center border border-green-500 transition-all';
                currentStatusEl.className = 'text-2xl font-bold text-green-600';
            } else {
                currentStatusEl.textContent = history.length > 0 ? '已下班' : '尚未打卡';
                statusCardEl.className = 'bg-gray-50 rounded-lg p-5 mb-6 text-center border transition-all';
                currentStatusEl.className = 'text-2xl font-bold text-gray-800';
            }
            
            clockInBtn.disabled = isClockedIn;
            clockOutBtn.disabled = !isClockedIn;
            
            if (workDurationInterval) clearInterval(workDurationInterval);
            const calculateAndRenderDuration = () => {
                const duration = calculateWorkDuration(history, isClockedIn);
                workDurationEl.textContent = `${duration.hours} 小時 ${duration.minutes} 分`;
            };
            calculateAndRenderDuration();
            if(isClockedIn) {
                 workDurationInterval = setInterval(calculateAndRenderDuration, 60000);
            }
        }
        
        function renderHistory(history) {
            historyLogEl.innerHTML = '';
            if (history.length === 0) {
                historyLogEl.innerHTML = `<p class="text-gray-500 text-center py-4">今日尚無紀錄</p>`;
            } else {
                history.forEach(item => {
                    const typeText = item.type === 'in' ? '上班' : '下班';
                    const typeColor = item.type === 'in' ? 'text-green-600' : 'text-red-600';
                    const logItem = document.createElement('div');
                    logItem.className = 'bg-gray-50 p-3 rounded-lg border flex justify-between items-center';
                    logItem.innerHTML = `
                        <div>
                            <p class="font-semibold"><span class="${typeColor} font-bold">${typeText}</span></p>
                            <p class="text-sm text-gray-600">${item.timestamp.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}</p>
                        </div>
                        <a href="${item.mapLink}" target="blank" class="text-sm text-indigo-500 hover:text-indigo-700 flex items-center space-x-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                            <span>查看地圖</span>
                        </a>`;
                    historyLogEl.appendChild(logItem);
                });
            }
        }
        function clearMainView() {
            historyLogEl.innerHTML = `<p class="text-gray-500 text-center py-4">請先登入以查看紀錄。</p>`;
            currentStatusEl.textContent = '未登入';
            workDurationEl.textContent = '-- 小時 -- 分';
            userEmailDisplay.textContent = '';
        }
        function renderError(error) {
            historyLogEl.innerHTML = '';
            const errorMsgEl = document.createElement('p');
            errorMsgEl.className = 'text-red-500 text-center py-4';
            errorMsgEl.textContent = '無法載入紀錄，請檢查網路連線。';
            if (error.code === 'failed-precondition') {
                errorMsgEl.innerHTML += '<br><span class="text-sm text-gray-600">提示：資料庫缺少必要索引，請根據控制台的錯誤連結在 Firebase 後台建立。</span>';
            }
            historyLogEl.appendChild(errorMsgEl);
        }

        // --- 工具函式 ---
        function showMessage(message, type = 'info') {
            const typeClasses = {
                success: 'bg-green-100 text-green-800', error: 'bg-red-100 text-red-800',
                loading: 'bg-blue-100 text-blue-800', info: 'bg-gray-100 text-gray-800'
            };
            messageContentEl.textContent = message;
            messageBoxEl.className = `p-4 mb-4 text-sm rounded-lg ${typeClasses[type]}`;
            messageBoxEl.classList.remove('hidden');
            if (type === 'success' || type === 'error') {
                setTimeout(() => messageBoxEl.classList.add('hidden'), 3000);
            }
        }

        function toggleButtonLoading(button, isLoading, text) {
            button.disabled = isLoading;
            const originalIcon = button.querySelector('svg');
            if (isLoading) {
                button.dataset.originalContent = button.innerHTML;
                button.innerHTML = `<div class="spinner"></div><span>${text}</span>`;
            } else {
                const iconSpan = originalIcon ? originalIcon.outerHTML : '';
                button.innerHTML = `${iconSpan}<span>${text}</span>`;
            }
        }
        
        function calculateWorkDuration(history, isClockedIn) {
            let totalMilliseconds = 0;
            const chronologicalHistory = [...history].reverse();
            let lastClockInTime = null;
            chronologicalHistory.forEach(record => {
                if (record.type === 'in') {
                    lastClockInTime = record.timestamp;
                } else if (record.type === 'out' && lastClockInTime) {
                    totalMilliseconds += record.timestamp - lastClockInTime;
                    lastClockInTime = null;
                }
            });
            if (isClockedIn && lastClockInTime) {
                totalMilliseconds += new Date() - lastClockInTime;
            }
            const totalMinutes = Math.floor(totalMilliseconds / 60000);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return { hours, minutes };
        }
    }
</script>
</body>
</html>
