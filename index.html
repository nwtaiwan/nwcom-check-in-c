<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>西北勤務打卡系統</title>
    <link rel="icon" type="image/png" href="https://static.wixstatic.com/media/6148f9_56377cef73c1498f95a2c3057b89f2ed~mv2.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Leaflet Map Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; touch-action: manipulation; }
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s ease-in-out infinite;
        }
        .spinner-gray {
            border: 2px solid #e5e7eb; /* gray-200 */
            border-radius: 50%;
            border-top-color: #4b5563; /* gray-600 */
            width: 16px;
            height: 16px;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #map { height: 300px; } /* Increased map height for better view */
        #camera-modal, #add-account-modal { z-index: 1000; }
    </style>
</head>
<body class="bg-red-600 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg overflow-hidden flex flex-col h-screen max-h-[95vh]">
        
        <!-- 登入畫面 -->
        <div id="login-view" class="flex-1 overflow-y-auto">
            <header class="bg-white p-6 text-center">
                <img src="https://static.wixstatic.com/media/6148f9_56377cef73c1498f95a2c3057b89f2ed~mv2.png" alt="西北保全 Logo" class="mx-auto" style="width: 120px; height: 60px;">
                <h1 class="text-xl font-bold text-red-600 mt-4">西北勤務打卡系統</h1>
            </header>
            <main class="p-6 md:p-8">
                <div class="space-y-4">
                    <div>
                        <div class="flex items-center justify-between">
                            <label for="email" class="block text-sm font-medium text-gray-700">電子郵件</label>
                            <div class="flex items-center text-sm">
                                <input id="remember-me" type="checkbox" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                                <label for="remember-me" class="ml-1.5 text-gray-700">記住我</label>
                            </div>
                        </div>
                        <input type="email" id="email" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="your.email@company.com">
                    </div>
                    <div>
                        <div class="flex items-center justify-between">
                             <label for="login-password" class="block text-sm font-medium text-gray-700">密碼</label>
                             <a href="#" id="forgot-password-link" class="text-sm text-red-600 hover:text-red-500">忘記密碼?</a>
                        </div>
                        <div class="relative mt-1">
                            <input type="password" id="login-password" class="block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500 pr-10" placeholder="••••••••">
                            <button type="button" id="toggle-password-btn" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-700">
                            </button>
                        </div>
                    </div>
                    <button id="login-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>
                        <span>登入</span>
                    </button>
                    <p id="login-message" class="text-red-500 text-sm text-center min-h-[20px]"></p>
                </div>
            </main>
        </div>

        <!-- 主操作畫面 -->
        <div id="main-view" class="hidden flex-1 flex flex-col">
            <header class="bg-red-600 text-white p-6 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <img src="https://static.wixstatic.com/media/6148f9_56377cef73c1498f95a2c3057b89f2ed~mv2.png" alt="西北保全 Logo" style="width: 40px; height: 20px; object-fit: contain;">
                    <div>
                        <h1 class="text-xl font-bold">西北勤務打卡系統</h1>
                        <p id="user-email-display" class="text-sm opacity-90"></p>
                    </div>
                </div>
                <button id="logout-btn" class="bg-white hover:bg-gray-100 text-red-600 font-bold py-2 px-4 rounded-lg shadow-sm border border-red-700 transition-colors flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                    <span>登出</span>
                </button>
            </header>

            <!-- 可滾動的內容區域 -->
            <main class="flex-1 overflow-y-auto p-6 md:p-8 bg-gray-100">
                <div id="message-box" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert">
                    <span class="font-medium" id="message-content"></span>
                </div>

                <!-- 儀表板頁面 -->
                <div id="dashboard-page">
                    <!-- 狀態顯示區 -->
                    <div id="status-card" class="bg-white rounded-lg p-5 mb-6 text-center border transition-all">
                         <div class="flex justify-between items-center">
                            <div class="text-left">
                                <h2 class="text-lg font-semibold text-gray-700 mb-1">目前狀態</h2>
                                <p id="current-status" class="text-2xl font-bold text-gray-800">尚未打卡</p>
                            </div>
                            <div class="text-right">
                                 <h2 class="text-lg font-semibold text-gray-700 mb-1">今日工時</h2>
                                <p id="work-duration" class="text-2xl font-bold text-gray-800">-- 小時 -- 分</p>
                            </div>
                         </div>
                    </div>
                    <!-- 打卡紀錄 -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-3 border-b pb-2">今日打卡紀錄</h3>
                        <div id="history-log" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                        </div>
                    </div>
                </div>

                <!-- 打卡頁面 -->
                <div id="checkin-page" class="hidden">
                     <!-- Map Display -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3 border-b pb-2 flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                                <span>目前位置</span>
                            </div>
                            <button id="relocate-btn" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-1 px-3 rounded-lg border border-gray-300 flex items-center space-x-1.5 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                                <span>重新定位</span>
                            </button>
                        </h3>
                        <div id="map" class="w-full rounded-lg bg-gray-200 flex items-center justify-center text-gray-500 overflow-hidden">
                            正在取得 GPS 定位...
                        </div>
                    </div>
                    <!-- 打卡按鈕區 -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <button id="clock-in-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-4 rounded-lg shadow-md transition-all duration-200 flex items-center justify-center space-x-2 disabled:bg-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10.5V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h12.5"/><path d="m16 16-2 2 4 4 4-4-2-2"/><path d="M18 10V2"/></svg>
                            <span>上班打卡</span>
                        </button>
                        <button id="clock-out-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-4 rounded-lg shadow-md transition-all duration-200 flex items-center justify-center space-x-2 disabled:bg-gray-400" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 13.5V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h12.5"/><path d="m16 22 5-5-5-5"/><path d="M18 10V2"/></svg>
                            <span>下班打卡</span>
                        </button>
                    </div>
                </div>

                <!-- 設定頁面 -->
                <div id="settings-page" class="hidden">
                    <!-- Tab navigation -->
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                            <button id="settings-account-tab-btn" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                帳號
                            </button>
                            <button id="settings-rules-tab-btn" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                規則
                            </button>
                        </nav>
                    </div>

                    <!-- Tab content -->
                    <div class="mt-6">
                        <!-- Account Tab Content -->
                        <div id="settings-account-content">
                            <div class="flex justify-end mb-4">
                                <button id="add-account-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                    <span>新增帳號</span>
                                </button>
                            </div>
                            <div id="account-list" class="space-y-3">
                                <p class="text-gray-500 text-center py-4">正在載入帳號資料...</p>
                            </div>
                        </div>

                        <!-- Rules Tab Content -->
                        <div id="settings-rules-content" class="hidden">
                            <p class="text-gray-600 text-center py-10">系統開發中</p>
                        </div>
                    </div>
                </div>
            </main>

            <!-- 底部導覽列 -->
            <nav id="bottom-nav" class="w-full border-t bg-gray-50">
                <div class="flex justify-around">
                    <button id="nav-settings-btn" class="hidden flex-1 p-3 text-center text-gray-500 flex flex-col items-center justify-center space-y-1 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                        <span class="text-xs font-medium">設定</span>
                    </button>
                    <button id="nav-dashboard-btn" class="flex-1 p-3 text-center text-gray-500 flex flex-col items-center justify-center space-y-1 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
                        <span class="text-xs font-medium">儀表板</span>
                    </button>
                    <button id="nav-checkin-btn" class="flex-1 p-3 text-center text-gray-500 flex flex-col items-center justify-center space-y-1 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                        <span class="text-xs font-medium">打卡</span>
                    </button>
                </div>
            </nav>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="camera-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col max-h-full">
            <header class="p-4 border-b">
                <h3 id="camera-modal-title" class="text-lg font-bold text-center">打卡成功！</h3>
            </header>
            <main class="p-4 flex-1 overflow-y-auto">
                <div class="space-y-4">
                    <div class="relative w-full bg-gray-200 rounded-lg overflow-hidden">
                        <video id="camera-video" class="w-full h-auto" playsinline autoplay></video>
                        <canvas id="photo-canvas" class="hidden"></canvas>
                    </div>
                     <div>
                        <label for="photo-description" class="block text-sm font-medium text-gray-700">內容說明 (30字內)</label>
                        <textarea id="photo-description" rows="2" maxlength="30" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="請輸入說明..."></textarea>
                    </div>
                    <button id="take-photo-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
                        <span>拍照</span>
                    </button>
                    <div id="photo-preview-container" class="grid grid-cols-3 gap-2">
                        <!-- Photo thumbnails will be added here -->
                    </div>
                </div>
            </main>
            <footer class="p-4 bg-gray-50 border-t">
                <button id="close-camera-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                    完成
                </button>
            </footer>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div id="add-account-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col max-h-full">
            <header class="p-4 border-b flex justify-between items-center">
                <h3 id="add-account-modal-title" class="text-lg font-bold">新增帳號</h3>
                <button id="close-add-account-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </header>
            <main class="p-6 flex-1 overflow-y-auto">
                <form id="add-account-form" class="space-y-4">
                    <div>
                        <label for="new-account-username" class="block text-sm font-medium text-gray-700">帳號</label>
                        <input type="text" id="new-account-username" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div>
                        <label for="new-account-email" class="block text-sm font-medium text-gray-700">電子郵件</label>
                        <input type="email" id="new-account-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div>
                        <label for="new-account-password" class="block text-sm font-medium text-gray-700">密碼</label>
                        <input type="password" id="new-account-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                    </div>
                     <div>
                        <label for="new-account-name" class="block text-sm font-medium text-gray-700">姓名</label>
                        <input type="text" id="new-account-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div>
                        <label for="new-account-role" class="block text-sm font-medium text-gray-700">角色</label>
                        <select id="new-account-role" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                            <option>員工</option>
                            <option>管理員</option>
                        </select>
                    </div>
                    <div>
                        <label for="new-account-title" class="block text-sm font-medium text-gray-700">職稱</label>
                        <input type="text" id="new-account-title" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                    </div>
                     <div>
                        <label for="new-account-phone" class="block text-sm font-medium text-gray-700">手機號碼</label>
                        <input type="tel" id="new-account-phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                    </div>
                </form>
            </main>
            <footer class="p-4 bg-gray-50 border-t flex justify-end space-x-3">
                <button id="cancel-add-account-btn" type="button" class="bg-white hover:bg-gray-100 text-gray-700 font-bold py-2 px-4 rounded-lg border">
                    取消
                </button>
                 <button id="submit-add-account-btn" type="submit" form="add-account-form" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">
                    儲存
                </button>
            </footer>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, orderBy, doc, updateDoc, arrayUnion, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyDr9Bk0x0MiauuO_mzPOnLhYdhJ08pdxLo",
          authDomain: "nwcom-check-in.firebaseapp.com",
          projectId: "nwcom-check-in",
          storageBucket: "nwcom-check-in.appspot.com",
          messagingSenderId: "598559960060",
          appId: "1:598559960060:web:197586299700c85a256079",
          measurementId: "G-2WY1HVMD2S"
        };

        // --- DOM 元素 ---
        const loginView = document.getElementById('login-view'), mainView = document.getElementById('main-view');
        const emailInput = document.getElementById('email'), passwordInput = document.getElementById('login-password');
        const togglePasswordBtn = document.getElementById('toggle-password-btn'), rememberMeCheckbox = document.getElementById('remember-me');
        const loginBtn = document.getElementById('login-btn'), loginMessage = document.getElementById('login-message');
        const logoutBtn = document.getElementById('logout-btn'), userEmailDisplay = document.getElementById('user-email-display');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const currentStatusEl = document.getElementById('current-status'), workDurationEl = document.getElementById('work-duration');
        const clockInBtn = document.getElementById('clock-in-btn'), clockOutBtn = document.getElementById('clock-out-btn');
        const historyLogEl = document.getElementById('history-log');
        const messageBoxEl = document.getElementById('message-box'), messageContentEl = document.getElementById('message-content');
        const statusCardEl = document.getElementById('status-card');
        const mapContainer = document.getElementById('map');
        const relocateBtn = document.getElementById('relocate-btn');
        
        // --- 頁面與導覽按鈕 ---
        const dashboardPage = document.getElementById('dashboard-page');
        const checkinPage = document.getElementById('checkin-page');
        const settingsPage = document.getElementById('settings-page');
        const navDashboardBtn = document.getElementById('nav-dashboard-btn');
        const navCheckinBtn = document.getElementById('nav-checkin-btn');
        const navSettingsBtn = document.getElementById('nav-settings-btn');

        // --- 設定頁面元素 ---
        const settingsAccountTabBtn = document.getElementById('settings-account-tab-btn');
        const settingsRulesTabBtn = document.getElementById('settings-rules-tab-btn');
        const settingsAccountContent = document.getElementById('settings-account-content');
        const settingsRulesContent = document.getElementById('settings-rules-content');
        const addAccountBtn = document.getElementById('add-account-btn');
        const accountList = document.getElementById('account-list');

        // --- 新增帳號 Modal 元素 ---
        const addAccountModal = document.getElementById('add-account-modal');
        const closeAddAccountModalBtn = document.getElementById('close-add-account-modal-btn');
        const cancelAddAccountBtn = document.getElementById('cancel-add-account-btn');
        const addAccountForm = document.getElementById('add-account-form');
        const submitAddAccountBtn = document.getElementById('submit-add-account-btn');

        // --- 相機 Modal 元素 ---
        const cameraModal = document.getElementById('camera-modal');
        const cameraModalTitle = document.getElementById('camera-modal-title');
        const videoElement = document.getElementById('camera-video');
        const canvasElement = document.getElementById('photo-canvas');
        const takePhotoBtn = document.getElementById('take-photo-btn');
        const closeCameraBtn = document.getElementById('close-camera-btn');
        const photoPreviewContainer = document.getElementById('photo-preview-container');
        const photoDescriptionInput = document.getElementById('photo-description');

        const eyeIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
        const eyeOffIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path><line x1="2" x2="22" y1="2" y2="22"></line></svg>`;
        
        let workDurationInterval = null, unsubscribeFromHistory = null, unsubscribeFromAccounts = null;
        let map = null, marker = null, currentPosition = null;
        let cameraStream = null;
        let currentUserRole = null;

        // --- Firebase 設定檢查 ---
        function checkFirebaseConfig() {
            if (firebaseConfig.apiKey.startsWith("AIzaSy") === false) {
                loginMessage.textContent = "錯誤：請在程式碼中貼上您的 Firebase 設定。";
                loginBtn.disabled = true;
                loginBtn.innerHTML = `<span>設定未完成</span>`;
                loginBtn.classList.replace('bg-red-600', 'bg-gray-400');
                return false;
            }
            return true;
        }
        
        // --- 權限管理 ---
        async function checkUserRole(userId) {
            try {
                const userDocRef = doc(db, "users", userId);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists() && userDocSnap.data().role === '管理員') {
                    currentUserRole = '管理員';
                } else {
                    currentUserRole = '員工';
                }
            } catch (error) {
                console.error("檢查使用者權限時發生錯誤:", error);
                currentUserRole = '員工'; // 發生錯誤時預設為一般員工
            }
        }

        // --- 主程式邏輯 ---
        if (checkFirebaseConfig()) {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            const storage = getStorage(app);
            
            initializeLoginScreen();
            initializeNavigation(); 
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    await checkUserRole(user.uid); // 登入後檢查權限
                    
                    // Control Settings Button Visibility
                    if (currentUserRole === '管理員') {
                        navSettingsBtn.classList.remove('hidden');
                    } else {
                        navSettingsBtn.classList.add('hidden');
                    }

                    document.body.classList.remove('bg-red-600');
                    document.body.classList.add('bg-gray-100');
                    loginView.classList.add('hidden');
                    mainView.classList.remove('hidden');
                    mainView.classList.add('flex');
                    userEmailDisplay.textContent = `歡迎, ${user.email}`;
                    listenToTodayRecords(user.uid);
                    getInitialLocation();
                    showPage('dashboard');
                } else {
                    currentUserRole = null; // 登出後清除權限
                    navSettingsBtn.classList.add('hidden'); // Ensure hidden on logout
                    document.body.classList.add('bg-red-600');
                    document.body.classList.remove('bg-gray-100');
                    loginView.classList.remove('hidden');
                    mainView.classList.add('hidden');
                    mainView.classList.remove('flex');
                    if (unsubscribeFromHistory) unsubscribeFromHistory();
                    if (unsubscribeFromAccounts) unsubscribeFromAccounts();
                    if (workDurationInterval) clearInterval(workDurationInterval);
                    cleanupLocationOnLogout();
                    clearMainView();
                }
            });
            
            // --- 頁面切換與互動邏輯 ---
            function initializeNavigation() {
                navSettingsBtn.addEventListener('click', () => showPage('settings'));
                navDashboardBtn.addEventListener('click', () => showPage('dashboard'));
                navCheckinBtn.addEventListener('click', () => showPage('checkin'));
                relocateBtn.addEventListener('click', forceRelocate);
                takePhotoBtn.addEventListener('click', takePhotoWithWatermark);
                closeCameraBtn.addEventListener('click', closeCameraModal);

                // 設定頁面監聽
                settingsAccountTabBtn.addEventListener('click', () => showSettingsTab('account'));
                settingsRulesTabBtn.addEventListener('click', () => showSettingsTab('rules'));
                addAccountBtn.addEventListener('click', openAddAccountModal);
                closeAddAccountModalBtn.addEventListener('click', closeAddAccountModal);
                cancelAddAccountBtn.addEventListener('click', closeAddAccountModal);
                addAccountForm.addEventListener('submit', handleAddAccountSubmit);
            }

            function setActiveTab(activeBtn) {
                const allButtons = [navDashboardBtn, navCheckinBtn, navSettingsBtn];
                
                // 1. Reset all buttons to the inactive state
                allButtons.forEach(btn => {
                    btn.classList.remove('text-red-600', 'bg-red-50');
                    btn.classList.add('text-gray-500');
                });
                
                // 2. Highlight the currently active button
                activeBtn.classList.remove('text-gray-500');
                activeBtn.classList.add('text-red-600', 'bg-red-50');
            }

            function showPage(pageName) {
                dashboardPage.classList.add('hidden');
                checkinPage.classList.add('hidden');
                settingsPage.classList.add('hidden');

                if (pageName === 'dashboard') {
                    dashboardPage.classList.remove('hidden');
                    setActiveTab(navDashboardBtn);
                } else if (pageName === 'checkin') {
                    checkinPage.classList.remove('hidden');
                    setActiveTab(navCheckinBtn);
                    if (map) {
                        setTimeout(() => map.invalidateSize(), 10);
                    }
                } else if (pageName === 'settings') {
                    if (currentUserRole !== '管理員') return; // 雙重保險
                    settingsPage.classList.remove('hidden');
                    setActiveTab(navSettingsBtn);
                    showSettingsTab('account'); // 預設顯示帳號分頁
                    listenToAccounts(); // 進入設定頁時開始監聽
                }
            }
            
            function showSettingsTab(tabName) {
                const activeClasses = 'border-red-500 text-red-600';
                const inactiveClasses = 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
                
                if (tabName === 'account') {
                    settingsAccountContent.classList.remove('hidden');
                    settingsRulesContent.classList.add('hidden');
                    settingsAccountTabBtn.className = `whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${activeClasses}`;
                    settingsRulesTabBtn.className = `whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${inactiveClasses}`;

                } else if (tabName === 'rules') {
                    settingsAccountContent.classList.add('hidden');
                    settingsRulesContent.classList.remove('hidden');
                    settingsRulesTabBtn.className = `whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${activeClasses}`;
                    settingsAccountTabBtn.className = `whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${inactiveClasses}`;
                }
            }

            function forceRelocate() {
                if (!navigator.geolocation) {
                    showMessage('您的瀏覽器不支援 GPS 定位。', 'error');
                    return;
                }
                relocateBtn.disabled = true;
                relocateBtn.innerHTML = `<div class="spinner-gray"></div><span class="text-xs">定位中</span>`;
                const resetRelocateBtn = () => {
                    relocateBtn.disabled = false;
                    relocateBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg><span>重新定位</span>`;
                };
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        currentPosition = pos;
                        const { latitude, longitude } = pos.coords;
                        const latLng = L.latLng(latitude, longitude);
                        if (!map) initMap(latLng);
                        else {
                            map.setView(latLng, 17);
                            marker.setLatLng(latLng);
                        }
                        showMessage('位置已更新！', 'success');
                        resetRelocateBtn();
                    },
                    (error) => {
                        let message = '無法取得 GPS 位置。';
                        if (error.code === error.PERMISSION_DENIED) message = '您已拒絕 GPS 定位權限。';
                        showMessage(message, 'error');
                        mapContainer.innerHTML = `<div class="p-4 text-center">${message}</div>`;
                        currentPosition = null;
                        resetRelocateBtn();
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }

            // --- 登入/登出相關 ---
            function initializeLoginScreen() {
                const savedEmail = localStorage.getItem('rememberedEmail');
                if (savedEmail) {
                    emailInput.value = savedEmail;
                    rememberMeCheckbox.checked = true;
                }
                togglePasswordBtn.innerHTML = eyeIcon;
            }

            loginBtn.addEventListener('click', async () => {
                const email = emailInput.value;
                const password = passwordInput.value;
                loginMessage.textContent = '';
                if (rememberMeCheckbox.checked) localStorage.setItem('rememberedEmail', email);
                else localStorage.removeItem('rememberedEmail');
                toggleButtonLoading(loginBtn, true, '登入中...');
                try {
                    if (email === '11' && password === '11') await signInWithEmailAndPassword(auth, 'test@company.com', 'password123');
                    else await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Login failed:", error);
                    const message = (error.code === 'auth/invalid-credential') ? '登入失敗，帳號或密碼錯誤。' : '登入時發生未知錯誤。';
                    loginMessage.textContent = message;
                } finally {
                    toggleButtonLoading(loginBtn, false, '登入');
                }
            });
            
            logoutBtn.addEventListener('click', () => signOut(auth));
            togglePasswordBtn.addEventListener('click', () => {
                const isPassword = passwordInput.type === 'password';
                passwordInput.type = isPassword ? 'text' : 'password';
                togglePasswordBtn.innerHTML = isPassword ? eyeOffIcon : eyeIcon;
            });
            forgotPasswordLink.addEventListener('click', (e) => {
                e.preventDefault();
                const email = emailInput.value;
                if (!email) {
                    loginMessage.textContent = '請先輸入您的電子郵件以重設密碼。';
                    return;
                }
                sendPasswordResetEmail(auth, email)
                    .then(() => {
                        loginMessage.textContent = `密碼重設信件已寄至 ${email}，請查收。`;
                        loginMessage.className = "text-green-600 text-sm text-center min-h-[20px]";
                    })
                    .catch((error) => {
                        loginMessage.textContent = '無法傳送密碼重設信件，請確認郵件地址是否正確。';
                        loginMessage.className = "text-red-500 text-sm text-center min-h-[20px]";
                    });
            });

            // --- 地圖與定位邏輯 ---
            function getInitialLocation() {
                if (!navigator.geolocation) {
                    mapContainer.innerHTML = '您的瀏覽器不支援 GPS 定位。';
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        currentPosition = pos;
                        const { latitude, longitude } = pos.coords;
                        const latLng = L.latLng(latitude, longitude);
                        if (!map) initMap(latLng);
                        else {
                            map.setView(latLng, 17);
                            marker.setLatLng(latLng);
                        }
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        let message = '無法取得 GPS 位置。';
                        if(error.code === error.PERMISSION_DENIED) message = '您已拒絕 GPS 定位權限，請至瀏覽器設定中重新開啟。';
                        mapContainer.innerHTML = `<div class="p-4 text-center">${message}</div>`;
                        currentPosition = null;
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }
            function cleanupLocationOnLogout() {
                if (map) {
                    map.remove();
                    map = null;
                }
                currentPosition = null;
                marker = null;
                mapContainer.innerHTML = '正在取得 GPS 定位...';
            }
            function initMap(latLng) {
                mapContainer.innerHTML = ''; 
                map = L.map('map').setView(latLng, 17);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);
                marker = L.marker(latLng).addTo(map);
            }

            // --- 打卡與相機邏輯 ---
            async function handleClockAction(type) {
                const user = auth.currentUser;
                if (!user) { showMessage('使用者未登入，無法打卡。', 'error'); return; }
                if (!currentPosition) { showMessage('無法取得您的目前位置，請檢查定位權限後再試。', 'error'); return; }

                const buttonToLoad = type === 'in' ? clockInBtn : clockOutBtn;
                const originalText = type === 'in' ? '上班打卡' : '下班打卡';
                toggleButtonLoading(buttonToLoad, true, '傳送中...');
                
                try {
                    const { latitude, longitude } = currentPosition.coords;
                    const record = {
                        userId: user.uid, userEmail: user.email, type,
                        timestamp: serverTimestamp(),
                        coords: { latitude, longitude },
                        mapLink: `https://www.openstreetmap.org/?mlat=${latitude}&mlon=${longitude}#map=18/${latitude}/${longitude}`,
                        photoURLs: []
                    };
                    const docRef = await addDoc(collection(db, "clock_records"), record);
                    const clockInType = type === 'in' ? '上班' : '下班';
                    showCameraModal(`${clockInType}打卡成功！`, docRef.id);
                } catch (error) {
                    showMessage('打卡失敗，同步資料時發生錯誤。', 'error');
                    console.error("Clock action error:", error);
                } finally {
                    toggleButtonLoading(buttonToLoad, false, originalText);
                }
            }
            
            async function showCameraModal(title, recordId) {
                cameraModal.dataset.recordId = recordId;
                cameraModalTitle.textContent = title;
                photoPreviewContainer.innerHTML = '';
                photoDescriptionInput.value = '';
                cameraModal.classList.remove('hidden');
                try {
                    if (cameraStream) cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    videoElement.srcObject = cameraStream;
                } catch (err) {
                    console.error("Error accessing camera:", err);
                    showMessage('無法開啟相機，請檢查權限。', 'error');
                    closeCameraModal();
                }
            }

            async function takePhotoWithWatermark() {
                const video = videoElement;
                if (!video || !video.videoWidth) {
                    showMessage('相機尚未就緒，請稍候再試。', 'error');
                    console.error("Take photo attempt failed: Video stream not ready or has 0 width.");
                    return;
                }

                const recordId = cameraModal.dataset.recordId;
                if (!recordId) {
                    showMessage('錯誤：找不到打卡紀錄ID。', 'error');
                    return;
                }

                const canvas = canvasElement;
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                const user = auth.currentUser;
                const now = new Date();
                const dateTime = now.toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const userEmail = user ? user.email : 'N/A';
                const gpsCoords = currentPosition ? `${currentPosition.coords.latitude.toFixed(5)}, ${currentPosition.coords.longitude.toFixed(5)}` : 'No GPS';
                const description = photoDescriptionInput.value.trim();

                const textLines = [dateTime, userEmail, `GPS: ${gpsCoords}`];
                if (description) {
                    textLines.push(description);
                }

                context.font = '24px "Noto Sans TC"';
                context.textBaseline = 'bottom';
                
                const padding = 10;
                const lineHeight = 30;
                const boxHeight = (lineHeight * textLines.length) + (padding * 2);
                
                context.fillStyle = 'rgba(0, 0, 0, 0.6)';
                const textWidth = Math.max(...textLines.map(line => context.measureText(line).width));
                const boxWidth = textWidth + (padding * 2);
                context.fillRect(padding, canvas.height - boxHeight - padding, boxWidth, boxHeight);
                
                context.fillStyle = 'white';
                textLines.forEach((line, index) => {
                    context.fillText(line, padding * 2, canvas.height - padding - (lineHeight * (textLines.length - 1 - index) ));
                });
                
                const dataUrl = canvas.toDataURL('image/jpeg');
                
                try {
                    const photoName = `${Date.now()}.jpg`;
                    const storageRef = ref(storage, `photos/${user.uid}/${recordId}/${photoName}`);
                    const uploadResult = await uploadString(storageRef, dataUrl, 'data_url');
                    const downloadURL = await getDownloadURL(uploadResult.ref);
                    
                    const recordRef = doc(db, 'clock_records', recordId);
                    await updateDoc(recordRef, {
                        photoURLs: arrayUnion(downloadURL)
                    });

                    const img = document.createElement('img');
                    img.src = dataUrl;
                    img.className = 'w-full h-auto object-cover rounded';
                    photoPreviewContainer.appendChild(img);
                    photoDescriptionInput.value = '';
                    showMessage('照片已上傳！', 'success');

                } catch (error) {
                    console.error("Photo upload error:", error);
                    showMessage('照片上傳失敗。', 'error');
                }
            }

            function closeCameraModal() {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = null;
                }
                cameraModal.classList.add('hidden');
            }

            clockInBtn.addEventListener('click', () => handleClockAction('in'));
            clockOutBtn.addEventListener('click', () => handleClockAction('out'));
            
            // --- 設定頁面 Modal 與帳號管理 ---
            function openAddAccountModal() {
                addAccountModal.classList.remove('hidden');
            }

            function closeAddAccountModal() {
                addAccountForm.reset();
                addAccountModal.classList.add('hidden');
            }

            async function handleAddAccountSubmit(e) {
                e.preventDefault();
                toggleButtonLoading(submitAddAccountBtn, true, '儲存中...');
                
                const email = document.getElementById('new-account-email').value;
                const password = document.getElementById('new-account-password').value;

                const userData = {
                    username: document.getElementById('new-account-username').value,
                    email: email,
                    name: document.getElementById('new-account-name').value,
                    role: document.getElementById('new-account-role').value,
                    title: document.getElementById('new-account-title').value,
                    phone: document.getElementById('new-account-phone').value,
                    createdAt: serverTimestamp()
                };

                try {
                    // 步驟 1: 在 Firebase Authentication 建立使用者
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    // 步驟 2: 使用者的 UID 作為文件 ID，將設定檔存儲在 Firestore 中
                    await setDoc(doc(db, "users", user.uid), userData);

                    showMessage(`帳號 ${userData.name} 已成功建立。`, 'success');
                    closeAddAccountModal();
                } catch (error) {
                    console.error("新增帳號失敗:", error);
                    let message = '新增帳號失敗，請稍後再試。';
                    if (error.code === 'auth/email-already-in-use') {
                        message = '此電子郵件已被註冊。';
                    } else if (error.code === 'auth/weak-password') {
                        message = '密碼強度不足，請設定至少6位數的密碼。';
                    }
                    showMessage(message, 'error');
                } finally {
                    toggleButtonLoading(submitAddAccountBtn, false, '儲存');
                }
            }

            function listenToAccounts() {
                if (unsubscribeFromAccounts) unsubscribeFromAccounts(); // 取消先前的監聽
                
                const q = query(collection(db, "users"), orderBy("createdAt", "desc"));
                
                unsubscribeFromAccounts = onSnapshot(q, (snapshot) => {
                    const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAccountList(users);
                }, (error) => {
                    console.error("Error listening to accounts:", error);
                    accountList.innerHTML = `<p class="text-red-500 text-center py-4">無法載入帳號資料。權限不足。</p>`;
                });
            }

            function renderAccountList(users) {
                accountList.innerHTML = '';
                if (users.length === 0) {
                    accountList.innerHTML = `<p class="text-gray-500 text-center py-4">尚無帳號資料</p>`;
                    return;
                }

                users.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = 'bg-white p-4 rounded-lg border flex justify-between items-center';
                    
                    const roleColor = user.role === '管理員' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800';

                    userCard.innerHTML = `
                        <div>
                            <p class="font-bold text-gray-800">${user.name} <span class="text-sm font-medium ml-2 px-2 py-0.5 rounded-full ${roleColor}">${user.role}</span></p>
                            <p class="text-sm text-gray-600">${user.email}</p>
                            <p class="text-sm text-gray-500">${user.title || '無職稱'}</p>
                        </div>
                        <div>
                           <!-- 未來可放編輯/刪除按鈕 -->
                        </div>
                    `;
                    accountList.appendChild(userCard);
                });
            }

            // --- 資料監聽與畫面渲染 ---
            function listenToTodayRecords(userId) {
                if (unsubscribeFromHistory) unsubscribeFromHistory();
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const q = query(
                    collection(db, "clock_records"),
                    where("userId", "==", userId),
                    where("timestamp", ">=", today),
                    orderBy("timestamp", "desc")
                );
                unsubscribeFromHistory = onSnapshot(q, (snapshot) => {
                    const history = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return { ...data, id: doc.id, timestamp: data.timestamp?.toDate() };
                    }).filter(item => item.timestamp);
                    renderHistory(history);
                    updateUI(history);
                }, (error) => {
                    console.error("讀取紀錄失敗: ", error);
                    renderError(error);
                });
            }
            
            function updateUI(history) {
                const lastAction = history[0];
                const isClockedIn = lastAction && lastAction.type === 'in';
                
                if (isClockedIn) {
                    currentStatusEl.textContent = '工作中';
                    statusCardEl.className = 'bg-green-50 rounded-lg p-5 mb-6 text-center border border-green-500 transition-all';
                    currentStatusEl.className = 'text-2xl font-bold text-green-600';
                } else {
                    currentStatusEl.textContent = history.length > 0 ? '已下班' : '尚未打卡';
                    statusCardEl.className = 'bg-white rounded-lg p-5 mb-6 text-center border transition-all';
                    currentStatusEl.className = 'text-2xl font-bold text-gray-800';
                }
                
                clockInBtn.disabled = isClockedIn;
                clockOutBtn.disabled = !isClockedIn;
                
                if (workDurationInterval) clearInterval(workDurationInterval);
                const calculateAndRenderDuration = () => {
                    const duration = calculateWorkDuration(history, isClockedIn);
                    workDurationEl.textContent = `${duration.hours} 小時 ${duration.minutes} 分`;
                };
                calculateAndRenderDuration();
                if(isClockedIn) {
                     workDurationInterval = setInterval(calculateAndRenderDuration, 60000);
                }
            }
            
            function renderHistory(history) {
                historyLogEl.innerHTML = '';
                if (history.length === 0) {
                    historyLogEl.innerHTML = `<p class="text-gray-500 text-center py-4">今日尚無紀錄</p>`;
                } else {
                    history.forEach(item => {
                        const typeText = item.type === 'in' ? '上班' : '下班';
                        const typeColor = item.type === 'in' ? 'text-green-600' : 'text-red-600';
                        const logItem = document.createElement('div');
                        logItem.className = 'bg-white p-3 rounded-lg border flex justify-between items-center';
                        
                        let photoLinkHtml = '';
                        if (item.photoURLs && item.photoURLs.length > 0) {
                             photoLinkHtml = item.photoURLs.map(url => `
                            <a href="${url}" target="_blank" class="text-sm text-purple-500 hover:text-purple-700 flex items-center space-x-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                                <span>照片</span>
                            </a>`).join('');
                        }

                        logItem.innerHTML = `
                        <div class="flex-1">
                            <p class="font-semibold"><span class="${typeColor} font-bold">${typeText}</span></p>
                            <p class="text-sm text-gray-600">${item.timestamp.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            ${photoLinkHtml}
                            <a href="${item.mapLink}" target="_blank" class="text-sm text-indigo-500 hover:text-indigo-700 flex items-center space-x-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                                <span>地圖</span>
                            </a>
                        </div>`;
                        historyLogEl.appendChild(logItem);
                    });
                }
            }
            function clearMainView() {
                historyLogEl.innerHTML = `<p class="text-gray-500 text-center py-4">請先登入以查看紀錄。</p>`;
                currentStatusEl.textContent = '未登入';
                workDurationEl.textContent = '-- 小時 -- 分';
                userEmailDisplay.textContent = '';
                settingsPage.classList.add('hidden');
            }
            function renderError(error) {
                historyLogEl.innerHTML = '';
                const errorMsgEl = document.createElement('p');
                errorMsgEl.className = 'text-red-500 text-center py-4';
                errorMsgEl.textContent = '無法載入紀錄，請檢查網路連線。';
                if (error.code === 'failed-precondition') {
                    errorMsgEl.innerHTML += '<br><span class="text-sm text-gray-600">提示：資料庫缺少必要索引，請根據控制台的錯誤連結在 Firebase 後台建立。</span>';
                }
                historyLogEl.appendChild(errorMsgEl);
            }

            // --- 工具函式 ---
            function showMessage(message, type = 'info') {
                const typeClasses = {
                    success: 'bg-green-100 text-green-800', error: 'bg-red-100 text-red-800',
                    loading: 'bg-blue-100 text-blue-800', info: 'bg-gray-100 text-gray-800'
                };
                messageContentEl.textContent = message;
                messageBoxEl.className = `p-4 mb-4 text-sm rounded-lg ${typeClasses[type]}`;
                messageBoxEl.classList.remove('hidden');
                if (type === 'success' || type === 'error') {
                    setTimeout(() => messageBoxEl.classList.add('hidden'), 3000);
                }
            }

            function toggleButtonLoading(button, isLoading, text) {
                button.disabled = isLoading;
                const originalContent = button.innerHTML;
                if (isLoading) {
                    button.innerHTML = `<div class="spinner"></div><span>${text}</span>`;
                } else {
                    button.innerHTML = `<span>${text}</span>`;
                }
            }
            
            function calculateWorkDuration(history, isClockedIn) {
                let totalMilliseconds = 0;
                const chronologicalHistory = [...history].reverse();
                let lastClockInTime = null;
                chronologicalHistory.forEach(record => {
                    if (record.type === 'in') {
                        lastClockInTime = record.timestamp;
                    } else if (record.type === 'out' && lastClockInTime) {
                        totalMilliseconds += record.timestamp - lastClockInTime;
                        lastClockInTime = null;
                    }
                });
                if (isClockedIn && lastClockInTime) {
                    totalMilliseconds += new Date() - lastClockInTime;
                }
                const totalMinutes = Math.floor(totalMilliseconds / 60000);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                return { hours, minutes };
            }
        }
    </script>
</body>
</html>
